# Main Casino Infrastructure Implementation - Document 45.0.3.1

## Work Progress Tracking Table

| Phase | Status | Priority | Description |
|-------|--------|----------|-------------|
| Phase 1: Shared Casino Infrastructure | 🟡 Planned | 1 (Highest) | Core utilities, types, services, and hooks for ALL casino games |
| Phase 2: RNG & Game Logic Foundation | 🟡 Planned | 2 (Highest) | Random number generation, win detection, payout calculations |
| Phase 3: Shared Components & Animations | 🟡 Planned | 3 (Highest) | React Spring integration, shared UI components (BetControls, CoinDisplay, etc.) |
| Phase 4: Audio & Haptics System | 🟡 Planned | 4 (High) | Web Audio API, haptic feedback, sound management |
| Phase 5: Balance & State Management | 🟡 Planned | 5 (High) | Enhanced Zustand casino store, persistence, validation |
| Phase 6: Casino Index Page | 🟡 Planned | 6 (High) | Main casino page with game selection, stats, and navigation |
| Phase 8: Mobile Optimization | 🟡 Planned | 8 (Medium) | Touch gestures, performance, battery optimization |
| Phase 13: PWA Features | 🟡 Planned | 13 (Low) | Service workers, offline play, installation |

## Project Structure Overview

```
src/
├── components/
│   └── casino/              # Casino game components
│       ├── shared/          # Shared UI components (BetControls, CoinDisplay, etc.)
│       └── index/           # Casino index page components
├── hooks/
│   └── casino/              # Casino-specific React hooks (useCasinoAudio, useSlotMachine, etc.)
├── services/
│   └── casino/              # Casino game logic and external services (RNG, PayoutCalculation, etc.)
├── types/
│   └── casino/              # Casino TypeScript type definitions
├── utils/
│   └── casino/              # Casino pure utility functions (currency, validation, etc.)
├── constants/
│   └── casino/              # Casino game configuration constants (payouts, symbols, etc.)
├── animations/
│   └── casino/              # Casino React Spring animation configs
├── pages/
│   └── casino/              # Casino pages
│       └── CasinoIndexPage.tsx  # Main casino page with game selection and overview
└── stores/
    └── casinoStore.ts       # Casino-specific Zustand store (shared across all games)
```

## Phase 1: Shared Casino Infrastructure (Priority 1 - Highest)

### Overview
Establish core infrastructure for casino games including types, utilities, services, and foundational hooks following SRP and DRY principles.

### Files to Create
- `src/types/casino/index.ts`
- `src/types/casino/slot-machine.types.ts`
- `src/types/casino/casino-game.types.ts`
- `src/types/casino/audio.types.ts`
- `src/utils/casino/index.ts`
- `src/utils/casino/random.utils.ts`
- `src/utils/casino/currency.utils.ts`
- `src/utils/casino/validation.utils.ts`
- `src/constants/casino/index.ts`
- `src/constants/casino/slot-symbols.constants.ts`
- `src/constants/casino/payout-tables.constants.ts`
- `src/services/casino/index.ts`
- `src/services/casino/CasinoRNGService.ts`
- `src/hooks/casino/index.ts`
- `src/hooks/casino/useCasinoAudio.ts`
- `src/hooks/casino/useHapticFeedback.ts`

### Files to Modify
- `src/types/index.ts` (add casino type exports)
- `src/components/layout/types.ts` (add casino tab types)

### Integration Points (Files Used But Not Modified)
- `src/stores/appStore.ts` (for coinBalance state)
- `src/services/audio/audioService.ts` (for base audio functionality)
- `src/components/layout/TabBar.tsx` (existing casino tab)

### Key Deliverables
1. **Type System**: Complete TypeScript definitions for all casino games
2. **Crypto RNG**: `crypto.getRandomValues()` implementation replacing `Math.random()` for provably fair gaming
3. **Currency Utils**: Chess-themed coin formatting with comma separators, balance validation (minimum 0)
4. **Audio Foundation**: Web Audio API setup with 64kbps MP3 compression, <50KB file sizes, audio pooling
5. **Haptic System**: Vibration API patterns - `[200]` for wins, `[100,50,100]` for big wins, with user toggle

### Implementation Code

**CasinoRNGService.ts**:
```typescript
// Cryptographically secure RNG
const generateSecureRandom = (): number => {
  const array = new Uint32Array(1)
  crypto.getRandomValues(array)
  return array[0] / (0xFFFFFFFF + 1)
}

// Weighted symbol selection with chess pieces
const CHESS_SYMBOL_WEIGHTS = {
  '♔': 0.05, // King - 5% (rarest)
  '♕': 0.08, // Queen - 8%
  '♖': 0.12, // Rook - 12%
  '♗': 0.15, // Bishop - 15%
  '♘': 0.15, // Knight - 15%
  '♙': 0.20, // Pawn - 20% (most common)
  // Black pieces with same weights
}
```

**hooks/casino/useCasinoAudio.ts**:
```typescript
// Battery-efficient audio with preloading
const AUDIO_CONFIG = {
  spinSound: { duration: 1.5, volume: 0.8 },
  winSound: { duration: 0.5, volume: 1.0 },
  ambientVolume: 0.2, // 20% background, 80% effects
  maxConcurrentSounds: 3
}
```

**hooks/casino/useHapticFeedback.ts**:
```typescript
// Vibration patterns from research
const HAPTIC_PATTERNS = {
  spin: [100],
  smallWin: [200],
  bigWin: [100, 50, 100, 50, 200],
  maxDuration: 500 // Battery optimization
}
```

## Phase 2: RNG & Game Logic Foundation (Priority 2 - Highest)

### Overview
Implement core game logic systems including weighted randomization, win detection, and payout calculations.

### Files to Create
- `src/services/casino/SlotGameLogic.ts`
- `src/services/casino/WinDetectionService.ts`
- `src/services/casino/PayoutCalculationService.ts`
- `src/utils/casino/slot-game.utils.ts`
- `src/utils/casino/probability.utils.ts`
- `src/hooks/casino/useSlotMachine.ts`
- `src/constants/casino/slot-paylines.constants.ts`
- `src/constants/casino/win-combinations.constants.ts`

### Files to Modify
- `src/services/casino/index.ts` (add exports)
- `src/hooks/casino/index.ts` (add exports)

### Integration Points
- `src/services/casino/CasinoRNGService.ts` (from Phase 1)
- `src/constants/casino/payout-tables.constants.ts` (from Phase 1)
- `src/stores/appStore.ts` (for balance updates)

### Key Deliverables
1. **Weighted RNG**: Chess piece probability distribution with near-miss logic (15-20% of losing spins)
2. **Payline Evaluation**: Single center line `[1,1,1]` optimized for mobile screens
3. **Chess Payout System**: Pawn=2x, Rook=5x, Knight=8x, Bishop=10x, Queen=25x, King=100x
4. **Game Hook**: Complete slot machine cycle with balance validation and win celebration
5. **Mathematical Testing**: RTP verification and randomness validation with deterministic seeds

### Implementation Code

**services/casino/SlotGameLogic.ts**:
```typescript
// Chess-themed payout table from research
const CHESS_PAYOUTS = {
  '♙♙♙': 2,   // Triple Pawn
  '♖♖♖': 5,   // Triple Rook 
  '♘♘♘': 8,   // Triple Knight
  '♗♗♗': 10,  // Triple Bishop
  '♕♕♕': 25,  // Triple Queen
  '♔♔♔': 100, // Triple King (jackpot)
}

// Near-miss implementation
const generateNearMiss = (symbols: string[]): boolean => {
  return Math.random() < 0.18 // 18% near-miss rate
}
```

**services/casino/WinDetectionService.ts**:
```typescript
// Single payline for mobile optimization
const MOBILE_PAYLINES = [
  [1, 1, 1] // Center line only for 3-reel mobile slot
]

// Win detection with visual feedback timing
const detectWin = (reels: string[]): WinResult => {
  const winAmount = CHESS_PAYOUTS[reels.join('')] || 0
  return {
    isWin: winAmount > 0,
    amount: winAmount,
    highlightDuration: 2000, // 2s win animation
    celebrationLevel: winAmount >= 25 ? 'big' : 'small'
  }
}
```

**hooks/casino/useSlotMachine.ts**:
```typescript
// Complete game cycle with research-based timing
const useSlotMachine = () => {
  const [isSpinning, setIsSpinning] = useState(false)
  const [reels, setReels] = useState(['♔', '♛', '♖'])
  
  const spin = useCallback(async () => {
    if (balance < wager) return // Balance validation
    
    setIsSpinning(true)
    setCoinBalance(prev => prev - wager) // Deduct immediately
    
    // 2-3 second spin with 200-300ms stagger
    await animateReels(2500, [0, 200, 400]) // Stagger delays
    
    const result = generateSpinResult()
    setReels(result.symbols)
    
    if (result.isWin) {
      setCoinBalance(prev => prev + result.winAmount)
      triggerWinCelebration(result.celebrationLevel)
    }
    
    setIsSpinning(false)
  }, [balance, wager])
}
```

## Phase 3: Shared Components & Animations (Priority 3 - Highest)

### Overview
Implement React Spring-based animation system for smooth, performant mobile gaming experiences.

### Files to Create
- `src/animations/casino/index.ts`
- `src/animations/casino/slot-reel.animations.ts`
- `src/animations/casino/win-celebration.animations.ts`
- `src/animations/casino/ui-feedback.animations.ts`
- `src/hooks/casino/useSlotAnimations.ts`
- `src/hooks/casino/useSpringTransitions.ts`
- `src/components/casino/shared/AnimatedCounter.tsx`
- `src/components/casino/shared/SpringTransition.tsx`

### Files to Modify
- `src/hooks/casino/index.ts` (add animation hooks)
- `src/components/casino/shared/index.ts` (create and add exports)

### Integration Points
- `src/hooks/casino/useSlotMachine.ts` (from Phase 2)
- `src/hooks/casino/useHapticFeedback.ts` (from Phase 1)
- React Spring library (external dependency)

### Key Deliverables
1. **React Spring Reels**: Hardware-accelerated spinning with `transform: translateY()` and spring physics
2. **Win Celebrations**: Scale/rotate effects for winning symbols, glowing borders, 1-2 second animations
3. **Touch Feedback**: 16ms response time with visual feedback (scale animation on tap)
4. **60fps Performance**: `will-change: transform`, easing curves (`ease-out`), <16ms render times
5. **Mobile Optimized**: Reduced motion accessibility option, prevent motion sickness patterns

### Implementation Code

**animations/casino/slot-reel.animations.ts**:
```typescript
// Hardware-accelerated spinning from research
const useReelSpring = (isSpinning: boolean, symbols: string[]) => {
  const springProps = useSpring({
    transform: isSpinning 
      ? 'translateY(-2000px)' // 2000px spin distance
      : 'translateY(0px)',
    config: {
      tension: 120,
      friction: 14,
      // Realistic deceleration curve
    },
    onRest: () => {
      // Reel stopped, trigger next reel with 200ms delay
    }
  })
  
  return {
    ...springProps,
    willChange: 'transform', // Hardware acceleration hint
  }
}

// Staggered reel stopping (authentic casino feel)
const REEL_STOP_DELAYS = [0, 200, 400] // ms between reel stops
```

**animations/casino/win-celebration.animations.ts**:
```typescript
// Win animation patterns from research
const useWinAnimation = (isWinning: boolean, winLevel: 'small' | 'big') => {
  const celebration = useSpring({
    scale: isWinning ? 1.1 : 1.0,
    rotateZ: isWinning ? 5 : 0,
    boxShadow: isWinning 
      ? '0 0 20px rgba(255, 215, 0, 0.8)' // Golden glow
      : '0 0 0px rgba(255, 215, 0, 0)',
    config: { duration: winLevel === 'big' ? 2000 : 1000 }
  })
  
  return celebration
}

// Near-miss "hesitation" effect
const useNearMissEffect = (isNearMiss: boolean) => {
  return useSpring({
    transform: isNearMiss 
      ? 'translateY(-10px) translateY(0px)' // Brief hesitation
      : 'translateY(0px)',
    config: { tension: 300, friction: 10 }
  })
}
```

**animations/casino/ui-feedback.animations.ts**:
```typescript
// Button feedback with 16ms response target
const useTouchFeedback = (isPressed: boolean) => {
  return useSpring({
    scale: isPressed ? 0.95 : 1.0,
    backgroundColor: isPressed ? '#4ade80' : '#22c55e',
    config: { duration: 150 }, // Sub-16ms response
    immediate: false
  })
}

// Accessibility: Reduced motion support
const useAccessibleAnimation = (normalConfig: any) => {
  const prefersReducedMotion = useMediaQuery('(prefers-reduced-motion: reduce)')
  
  return prefersReducedMotion 
    ? { ...normalConfig, config: { duration: 0 } } // Instant
    : normalConfig
}
```

## Phase 4: Audio & Haptics System (Priority 4 - High)

### Overview
Enhanced audio system with haptic feedback integration for immersive mobile gaming experience.

### Files to Create
- `src/services/casino/CasinoAudioService.ts`
- `src/services/casino/HapticFeedbackService.ts`
- `src/constants/casino/audio-config.constants.ts`
- `src/constants/casino/haptic-patterns.constants.ts`
- `src/utils/casino/audio.utils.ts`

### Files to Modify
- `src/hooks/casino/useCasinoAudio.ts` (enhance from Phase 1)
- `src/hooks/casino/useHapticFeedback.ts` (enhance from Phase 1)
- `src/services/casino/index.ts` (add exports)

### Integration Points
- `src/services/audio/audioService.ts` (base audio system)
- `src/stores/appStore.ts` (audio settings)
- Web Audio API and Vibration API (browser APIs)

### Key Deliverables
1. **Web Audio Integration**: 64kbps MP3 files <50KB each, audio context state detection for silent mode
2. **Haptic Patterns**: Research-specific vibration sequences with 500ms maximum duration
3. **Battery Efficiency**: Audio pooling, preload essential sounds only, pause when page not visible
4. **Cross-Device Audio**: Headphones vs speakers detection, volume mixing (ambient 20%, effects 80%)
5. **Accessibility**: Visual waveform indicators, captions for audio cues, ARIA labels

### Implementation Code

**services/casino/CasinoAudioService.ts**:
```typescript
// Battery-efficient audio from research findings
class CasinoAudioService {
  private audioPool = new Map<string, HTMLAudioElement[]>()
  private maxConcurrentSounds = 3
  
  // Preload only essential sounds (research: avoid background loops)
  async preloadEssentials() {
    const essentialSounds = [
      { id: 'spin', src: '/audio/spin.mp3', duration: 1500 },
      { id: 'win', src: '/audio/win.mp3', duration: 500 },
      { id: 'coin', src: '/audio/coin.mp3', duration: 300 }
    ]
    
    // Create audio pool for reuse
    for (const sound of essentialSounds) {
      this.audioPool.set(sound.id, [])
      for (let i = 0; i < 2; i++) { // Pool of 2 per sound
        const audio = new Audio(sound.src)
        audio.preload = 'auto'
        this.audioPool.get(sound.id)!.push(audio)
      }
    }
  }
  
  // Silent mode detection
  async playSafely(soundId: string, volume = 1.0) {
    if (document.visibilityState === 'hidden') return // Battery optimization
    
    try {
      await this.audioContext.resume() // Handle autoplay policy
      const audioPool = this.audioPool.get(soundId)
      if (!audioPool) return
      
      const availableAudio = audioPool.find(audio => audio.paused)
      if (availableAudio) {
        availableAudio.volume = volume * this.masterVolume
        availableAudio.currentTime = 0
        await availableAudio.play()
      }
    } catch (error) {
      // Graceful fallback - show visual feedback instead
      this.showVisualFeedback(soundId)
    }
  }
}
```

**services/casino/HapticFeedbackService.ts**:
```typescript
// Research-based haptic patterns
const HAPTIC_LIBRARY = {
  // From research: specific patterns for casino events
  spin: [100], // Short tap for spin start
  smallWin: [200], // Medium buzz for small wins
  bigWin: [100, 50, 100, 50, 200], // Complex pattern for big wins
  jackpot: [200, 100, 200, 100, 500], // Dramatic pattern
  error: [50, 50, 50], // Triple short for errors
}

class HapticService {
  private isEnabled = true
  private maxDuration = 500 // Battery optimization from research
  
  async vibrate(pattern: keyof typeof HAPTIC_LIBRARY) {
    if (!this.isEnabled || !navigator.vibrate) return
    
    const vibrationPattern = HAPTIC_LIBRARY[pattern]
    const totalDuration = vibrationPattern.reduce((sum, val) => sum + val, 0)
    
    // Respect battery optimization limit
    if (totalDuration <= this.maxDuration) {
      navigator.vibrate(vibrationPattern)
    }
  }
  
  // User preference toggle
  setEnabled(enabled: boolean) {
    this.isEnabled = enabled
    // Store in localStorage for persistence
    localStorage.setItem('hapticEnabled', enabled.toString())
  }
}
```

**constants/casino/audio-config.constants.ts**:
```typescript
// Research-based audio configuration
export const CASINO_AUDIO_CONFIG = {
  // File optimization from research
  compression: '64kbps', // Mobile data efficiency
  maxFileSize: 50000, // 50KB limit
  formats: ['mp3', 'ogg'], // MP3 primary, OGG fallback
  
  // Volume mixing ratios from research
  volumeMix: {
    ambient: 0.2,  // 20% background
    effects: 0.8,  // 80% sound effects
  },
  
  // Battery optimization settings
  pauseOnHidden: true, // Pause when tab not visible
  maxConcurrent: 3,    // Limit simultaneous sounds
  poolSize: 2,         // Audio instance reuse
  
  // Accessibility features
  visualIndicators: {
    spinSound: '🎰 Spinning...',
    winSound: '🎉 You won!', 
    coinSound: '🪙 Coins added',
    errorSound: '❌ Error occurred'
  }
} as const
```

## Phase 5: Balance & State Management (Priority 5 - High)

### Overview
Enhanced state management with comprehensive balance tracking, transaction logging, and persistence.

### Files to Create
- `src/stores/casinoStore.ts`
- `src/services/casino/BalanceService.ts`
- `src/services/casino/TransactionLogger.ts`
- `src/utils/casino/storage.utils.ts`
- `src/hooks/casino/useCasinoBalance.ts`
- `src/hooks/casino/useGameSession.ts`
- `src/types/casino/transaction.types.ts`

### Files to Modify
- `src/stores/appStore.ts` (integrate casino store)
- `src/types/casino/index.ts` (add transaction types)
- `src/hooks/casino/index.ts` (add balance hooks)

### Integration Points
- Zustand persistence middleware
- IndexedDB/localStorage APIs
- All casino components (for balance updates)

### Key Deliverables
1. **Zustand Casino Store**: Persistent store with `partialize` for selective localStorage sync
2. **Atomic Balance Updates**: Functional updates `setBalance(prev => prev - wager)` preventing race conditions
3. **IndexedDB Transactions**: Structured logging with Dexie.js, schema: `{gameType, timestamp, bet, winAmount, balance}`
4. **Session Persistence**: `beforeunload` + `visibilitychange` handlers for state backup
5. **Balance Validation**: Prevent negative balances, insufficient funds graceful handling

### Implementation Code

**stores/casinoStore.ts**:
```typescript
// Research-optimized Zustand store
interface CasinoState {
  // Game state
  coinBalance: number
  currentGame: 'slots' | 'blackjack' | 'poker' | null
  gameSession: GameSession
  
  // Transaction tracking
  transactionHistory: Transaction[]
  sessionStats: SessionStats
  
  // UI state
  isGameActive: boolean
  lastWinAmount: number
}

interface CasinoActions {
  // Atomic balance operations from research
  placeBet: (amount: number) => boolean // Returns false if insufficient funds
  addWinnings: (amount: number) => void
  resetBalance: () => void
  
  // Transaction logging
  logTransaction: (transaction: Transaction) => void
  getGameHistory: (gameType: string) => Transaction[]
  
  // Session management
  startGameSession: (gameType: string) => void
  endGameSession: () => void
}

export const useCasinoStore = create<CasinoState & CasinoActions>()(
  subscribeWithSelector(
    persist(
      (set, get) => ({
        // Initial state
        coinBalance: 1000, // Starting balance
        currentGame: null,
        gameSession: null,
        transactionHistory: [],
        sessionStats: { totalWagered: 0, totalWon: 0, sessionsPlayed: 0 },
        isGameActive: false,
        lastWinAmount: 0,
        
        // Research: Atomic balance operations prevent race conditions
        placeBet: (amount: number) => {
          const { coinBalance } = get()
          if (coinBalance < amount) {
            // Research: Graceful insufficient funds handling
            return false
          }
          
          set((state) => ({ 
            coinBalance: state.coinBalance - amount,
            // Log transaction immediately
            transactionHistory: [
              ...state.transactionHistory,
              {
                id: crypto.randomUUID(),
                gameType: state.currentGame!,
                type: 'bet',
                amount: -amount,
                balance: state.coinBalance - amount,
                timestamp: Date.now()
              }
            ]
          }))
          
          return true
        },
        
        addWinnings: (amount: number) => {
          set((state) => ({
            coinBalance: state.coinBalance + amount,
            lastWinAmount: amount,
            transactionHistory: [
              ...state.transactionHistory,
              {
                id: crypto.randomUUID(),
                gameType: state.currentGame!,
                type: 'win',
                amount: amount,
                balance: state.coinBalance + amount,
                timestamp: Date.now()
              }
            ]
          }))
        },
        
        // Session management for analytics
        startGameSession: (gameType: string) => {
          set({
            currentGame: gameType,
            isGameActive: true,
            gameSession: {
              id: crypto.randomUUID(),
              gameType,
              startTime: Date.now(),
              startBalance: get().coinBalance
            }
          })
        },
        
        endGameSession: () => {
          const { gameSession, coinBalance } = get()
          if (gameSession) {
            // Log session statistics
            const sessionData = {
              ...gameSession,
              endTime: Date.now(),
              endBalance: coinBalance,
              netGain: coinBalance - gameSession.startBalance
            }
            
            // Store in IndexedDB for analytics
            // ... session logging code ...
          }
          
          set({
            isGameActive: false,
            currentGame: null,
            gameSession: null
          })
        }
      }),
      {
        name: 'casino-store',
        partialize: (state) => ({
          coinBalance: state.coinBalance,
          sessionStats: state.sessionStats
        })
      }
    )
  )
)
```

## Phase 6: Casino Index Page (Priority 6 - High)

### Overview
Main casino landing page with game selection, player statistics, and navigation to individual games.

### Files to Create
- `src/pages/casino/CasinoIndexPage.tsx`
- `src/components/casino/index/GameSelectionGrid.tsx`
- `src/components/casino/index/PlayerStatsCard.tsx`
- `src/components/casino/index/RecentActivityFeed.tsx`
- `src/components/casino/shared/GameCard.tsx`
- `src/components/casino/shared/CoinDisplay.tsx`
- `src/components/casino/shared/GameLayout.tsx`

### Files to Modify
- `src/App.tsx` (add casino index route)
- `src/components/casino/shared/index.ts` (add shared components)

### Integration Points
- `src/stores/casinoStore.ts` (player stats and balance)
- `src/hooks/casino/useGameSession.ts` (session management)
- All casino game pages (navigation targets)

### Key Deliverables
1. **Game Selection**: Visual grid with game previews, play buttons, and difficulty indicators
2. **Player Dashboard**: Balance display, session stats, recent activity with animations
3. **Navigation System**: Smooth transitions between casino index and individual games
4. **Responsive Design**: Mobile-first layout with touch-friendly game selection
5. **Progress Tracking**: Achievement system, game completion status, win/loss statistics

## Phase 8: Mobile Optimization (Priority 8 - Medium)

### Overview
Mobile-specific optimizations for touch interactions, performance, and battery efficiency.

### Files to Create
- `src/hooks/casino/useTouchGestures.ts`
- `src/hooks/casino/usePerformanceMonitoring.ts`
- `src/utils/casino/mobile-detection.utils.ts`
- `src/utils/casino/performance.utils.ts`
- `src/services/casino/PerformanceService.ts`
- `src/components/casino/shared/TouchFeedback.tsx`

### Files to Modify
- All casino components (add mobile optimizations)
- `src/hooks/casino/index.ts` (add mobile hooks)
- `src/utils/casino/index.ts` (add mobile utils)

### Integration Points
- All existing casino components
- Performance Observer API
- Battery API (when available)
- Screen Wake Lock API

### Key Deliverables
1. **Touch Gestures**: Tap primary actions, long-press (500ms+) for rapid bet adjust, 44px minimum targets
2. **Performance Tracking**: `performance.now()` frame timing, FPS counter, <16ms React render target
3. **Battery Optimization**: Pause animations when `visibilityState === 'hidden'`, reduce complexity on low battery
4. **Responsive Design**: CSS Grid `minmax()`, 320px-1024px viewport support, orientation handling
5. **Mobile Accessibility**: Screen reader support, high contrast mode, reduce motion preferences

### Implementation Code

**hooks/casino/useTouchGestures.ts**:
```typescript
// Research-based touch interaction patterns
const useTouchGestures = () => {
  const [isLongPressing, setIsLongPressing] = useState(false)
  const longPressTimer = useRef<number>()
  
  // Research: 500ms+ long press for rapid bet adjustment
  const handleTouchStart = useCallback((action: () => void) => {
    longPressTimer.current = window.setTimeout(() => {
      setIsLongPressing(true)
      // Start rapid repeat every 100ms
      const interval = setInterval(action, 100)
      
      const cleanup = () => {
        clearInterval(interval)
        setIsLongPressing(false)
      }
      
      // Research: Clean up on touch end
      const handleTouchEnd = () => {
        cleanup()
        document.removeEventListener('touchend', handleTouchEnd)
      }
      
      document.addEventListener('touchend', handleTouchEnd)
    }, 500) // Research: 500ms threshold
  }, [])
  
  const handleTouchEnd = useCallback(() => {
    if (longPressTimer.current) {
      clearTimeout(longPressTimer.current)
    }
  }, [])
  
  return { handleTouchStart, handleTouchEnd, isLongPressing }
}
```

**hooks/casino/usePerformanceMonitoring.ts**:
```typescript
// Research: Performance monitoring for 60fps target
const usePerformanceMonitoring = () => {
  const [performanceMetrics, setPerformanceMetrics] = useState({
    fps: 60,
    frameTime: 16.67,
    memoryUsage: 0,
    isLowPerformance: false
  })
  
  useEffect(() => {
    let lastTime = performance.now()
    let frameCount = 0
    
    const measurePerformance = () => {
      const now = performance.now()
      const frameTime = now - lastTime
      frameCount++
      
      // Calculate FPS every 60 frames
      if (frameCount >= 60) {
        const fps = 1000 / (frameTime / frameCount)
        
        setPerformanceMetrics(prev => ({
          ...prev,
          fps: Math.round(fps),
          frameTime: frameTime / frameCount,
          isLowPerformance: fps < 45 // Performance threshold
        }))
        
        frameCount = 0
      }
      
      lastTime = now
      requestAnimationFrame(measurePerformance)
    }
    
    requestAnimationFrame(measurePerformance)
  }, [])
  
  return performanceMetrics
}
```

## Phase 13: PWA Features (Priority 13 - Low)

### Overview
Progressive Web App features for enhanced mobile experience including offline play and installation.

### Files to Create
- `public/sw.js` (service worker)
- `src/services/casino/PWAService.ts`
- `src/services/casino/CacheService.ts`
- `src/services/casino/OfflineGameService.ts`
- `src/hooks/casino/usePWAFeatures.ts`
- `src/hooks/casino/useOfflineGame.ts`
- `src/components/casino/shared/InstallPrompt.tsx`
- `src/components/casino/shared/OfflineIndicator.tsx`
- `src/utils/casino/cache.utils.ts`

### Files to Modify
- `public/manifest.json` (enhance PWA manifest)
- `src/main.tsx` (register service worker)
- `src/components/casino/shared/index.ts` (add PWA components)

### Integration Points
- Service Worker API
- Cache API
- IndexedDB for offline storage
- All casino games (offline functionality)

### Key Deliverables
1. **Service Worker**: Cache-First for game assets, Network-First for balance updates, 50MB cache limit
2. **Install Experience**: Install prompts after 3+ gaming sessions, fullscreen gaming with custom nav
3. **Offline Gaming**: Cached game assets, offline balance tracking with sync when online
4. **Device Features**: Screen Wake Lock for extended play, orientation lock for landscape games
5. **PWA Manifest**: `"display": "standalone"`, proper theming, 192x192 and 512x512 icons

### Implementation Code

**services/casino/PWAService.ts**:
```typescript
class PWAService {
  private deferredPrompt: any = null
  private installPromptThreshold = 3 // Gaming sessions before prompt
  
  async registerServiceWorker() {
    if ('serviceWorker' in navigator) {
      try {
        const registration = await navigator.serviceWorker.register('/sw.js')
        console.log('SW registered:', registration)
        
        // Listen for updates
        registration.addEventListener('updatefound', () => {
          this.handleServiceWorkerUpdate(registration)
        })
      } catch (error) {
        console.log('SW registration failed:', error)
      }
    }
  }
  
  async enableWakeLock() {
    if ('wakeLock' in navigator) {
      try {
        const wakeLock = await navigator.wakeLock.request('screen')
        console.log('Screen wake lock active')
        return wakeLock
      } catch (err) {
        console.log('Wake lock failed:', err)
      }
    }
  }
  
  async showInstallPrompt() {
    if (this.deferredPrompt) {
      this.deferredPrompt.prompt()
      const { outcome } = await this.deferredPrompt.userChoice
      console.log('Install prompt outcome:', outcome)
      this.deferredPrompt = null
    }
  }
  
  // Track gaming sessions for install prompt timing
  trackGamingSession() {
    const sessions = parseInt(localStorage.getItem('gamingSessions') || '0')
    const newSessions = sessions + 1
    localStorage.setItem('gamingSessions', newSessions.toString())
    
    if (newSessions >= this.installPromptThreshold && this.deferredPrompt) {
      // Show install prompt after threshold reached
      setTimeout(() => this.showInstallPrompt(), 2000)
    }
  }
}
```

**public/sw.js**:
```javascript
const CACHE_NAME = 'casino-v1'
const CACHE_SIZE_LIMIT = 52428800 // 50MB
const ESSENTIAL_ASSETS = [
  '/',
  '/static/css/main.css',
  '/static/js/main.js',
  '/audio/spin.mp3',
  '/audio/win.mp3',
  '/audio/coin.mp3'
]

// Cache-First strategy for game assets
self.addEventListener('fetch', (event) => {
  if (event.request.url.includes('/audio/') || 
      event.request.url.includes('/images/')) {
    event.respondWith(
      caches.match(event.request).then(response => {
        return response || fetch(event.request).then(fetchResponse => {
          const cache = caches.open(CACHE_NAME)
          cache.then(cache => cache.put(event.request, fetchResponse.clone()))
          return fetchResponse
        })
      })
    )
  }
})

// Network-First for balance updates
self.addEventListener('fetch', (event) => {
  if (event.request.url.includes('/api/balance')) {
    event.respondWith(
      fetch(event.request).catch(() => {
        // Return cached balance if offline
        return caches.match(event.request)
      })
    )
  }
})
```

## Implementation Guidelines

### Code Quality Standards
1. **TypeScript**: Strict mode with comprehensive type coverage
2. **Testing**: Minimum 80% code coverage for game logic
3. **Performance**: <16ms React render times, 60fps animations
4. **Accessibility**: WCAG 2.1 AA compliance
5. **Mobile**: Touch target minimum 44px, responsive design

### Architecture Principles
1. **Single Responsibility**: Each component/service has one clear purpose
2. **DRY**: Shared logic in utilities, hooks, and services
3. **Composition**: Favor composition over inheritance
4. **Immutability**: Immutable state updates throughout
5. **Error Boundaries**: Comprehensive error handling and recovery

### Development Workflow
1. **Phase Completion**: Each phase must pass all tests before next phase
2. **Code Reviews**: All casino game logic requires mathematical validation
3. **Device Testing**: Test on minimum 3 different mobile devices per phase
4. **Performance Validation**: Lighthouse CI scoring >90 for performance
5. **Accessibility Audit**: Screen reader testing for all new components

### Mobile-First Considerations
1. **Touch Targets**: Minimum 44x44px for all interactive elements
2. **Loading Performance**: <3s initial load on 3G connections
3. **Battery Efficiency**: Pause animations when page not visible
4. **Offline Support**: Essential functionality works without internet
5. **Installation**: PWA prompts appear after user engagement

### Security & Fair Play
1. **RNG Integrity**: Use `crypto.getRandomValues()` for all randomization
2. **Balance Protection**: Atomic updates prevent race conditions
3. **Audit Trail**: All transactions logged with timestamps
4. **Local Storage**: Encrypted sensitive data, plain text for preferences
5. **Mathematical Verification**: Regular RTP (Return to Player) validation