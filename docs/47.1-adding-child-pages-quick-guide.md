# Adding Child Pages - Quick Guide

## Overview

This is a simplified step-by-step guide for adding new child pages and their action sheet actions to the responsive chessboard application. For comprehensive architecture details, see [47-navigation-action-sheets-architecture.md](./47-navigation-action-sheets-architecture.md).

## Prerequisites

- Understanding of the app's tab-based navigation system
- Familiarity with Zustand store (`appStore.ts`)
- Knowledge of the action sheet system
- Understanding of the common actions system for reusable navigation

## Step-by-Step Process

### 1. Create the Child Page Component

Create your actual page component:

```typescript
// src/pages/parent/NewChildPage.tsx
import React from "react";

export const NewChildPage: React.FC = () => {
  return (
    <div className="p-6">
      <h1>New Child Page</h1>
      {/* Your page content */}
    </div>
  );
};
```

### 2. Create Wrapper Component

Create a wrapper that handles context setup:

```typescript
// src/components/NewChildPageWrapper.tsx
import React from "react";
import { usePageInstructions } from "../hooks/usePageInstructions";
import { NewChildPage } from "../pages/parent/NewChildPage";

export const NewChildPageWrapper: React.FC = () => {
  usePageInstructions("parent.newchildpage"); // Loads instructions for this page

  return <NewChildPage />;
};
```

**Critical:** The page ID (`"parent.newchildpage"`) must be consistent across all steps and match the hierarchical format used in the instructions service.

### 3. Add Child Page Actions

In `src/constants/actions/page-actions.constants.ts`:

#### Option A: Simple Page-Specific Actions Only
```typescript
export const PAGE_ACTIONS: Record<string, ActionSheetAction[]> = {
  // ... existing actions
  newchildpage: [
    {
      id: "child-specific-action",
      label: "Child Specific Action",
      icon: SomeIcon,
      variant: "default",
    },
    {
      id: "another-action",
      label: "Another Action",
      icon: AnotherIcon,
      variant: "secondary",
    },
  ],
};
```

#### Option B: Using Common Actions (Recommended)
```typescript
// Import common actions utilities
import { mergeWithCommonActions, buildCommonActions, COMMON_ACTION_GROUPS } from './common-actions.constants'

export const PAGE_ACTIONS: Record<string, ActionSheetAction[]> = {
  // ... existing actions
  
  // For child pages that need cross-navigation
  newchildpage: mergeWithCommonActions([
    {
      id: "child-specific-action",
      label: "Child Specific Action",
      icon: SomeIcon,
      variant: "default",
    },
    {
      id: "another-action",
      label: "Another Action",
      icon: AnotherIcon,
      variant: "secondary",
    },
  ], ['go-to-drag-test', 'go-to-audio-test', 'go-to-layout-test']), // Add navigation to sibling pages
  
  // For pages that only need navigation (no page-specific actions)
  anothernewpage: [...buildCommonActions(['go-to-minimal', 'go-to-animated', 'go-to-progress'])],
};
```

### 4. Add Navigation Action to Parent

#### 4a. Update Parent's Actions Hook

In the parent's actions hook (e.g., `src/hooks/useUITestsActions.ts`):

```typescript
const goToNewChildPage = useCallback(() => {
  setCurrentChildPage("newchildpage");
  playMove(false); // Audio feedback
}, [setCurrentChildPage, playMove]);

// Add to return object
return {
  // ... existing actions
  goToNewChildPage,
};
```

#### 4b. Add Navigation Action to Parent's PAGE_ACTIONS

**Option A: Manual Addition**
```typescript
export const PAGE_ACTIONS: Record<string, ActionSheetAction[]> = {
  uitests: [
    // or whichever parent tab
    // ... existing actions
    {
      id: "go-to-new-child",
      label: "Go to New Child Page",
      icon: Navigation,
      variant: "secondary",
    },
  ],
};
```

**Option B: Using Common Actions (Recommended)**
```typescript
// First, add your new navigation action to common-actions.constants.ts:
// In COMMON_ACTIONS object:
'go-to-new-child': {
  id: 'go-to-new-child',
  label: 'Go to New Child',
  icon: Navigation,
  variant: 'secondary'
},

// Then update the appropriate action group:
// In COMMON_ACTION_GROUPS:
uitestSiblings: [
  'go-to-drag-test',
  'go-to-audio-test', 
  'go-to-layout-test',
  'go-to-mobile-drag-test',
  'go-to-new-child' // Add your new navigation action
],

// Parent page actions now automatically include the new navigation:
uitests: [...COMMON_ACTION_GROUPS.uitestSiblings.map(name => ({
  ...COMMON_ACTIONS[name],
  variant: 'secondary' as const
}))],
```

### 5. Create Child Actions Hook

Create `src/hooks/useNewChildPageActions.ts`:

```typescript
import { useCallback } from "react";
import { useChessAudio } from "../services/audioService";

export function useNewChildPageActions() {
  const { playMove } = useChessAudio();

  const childSpecificAction = useCallback(() => {
    console.log("üéØ Child specific action executed");
    playMove(false);
    // Your action implementation
  }, [playMove]);

  const anotherAction = useCallback(() => {
    console.log("üöÄ Another action executed");
    playMove(false);
    // Your action implementation
  }, [playMove]);

  return {
    childSpecificAction,
    anotherAction,
  };
}
```

### 6. Wire Up Actions in ActionSheetContainer

In `src/components/action-sheet/ActionSheetContainer.tsx`:

#### 6a. Import the Hooks

```typescript
import { useNewChildPageActions } from "../../hooks/useNewChildPageActions";
```

#### 6b. Use the Hook

```typescript
// Inside ActionSheetContainer function
const newChildPageActions = useNewChildPageActions();
```

#### 6c. Add to Action Map

```typescript
const actionMap: Record<string, Record<string, Fn>> = {
  // ... existing mappings
  uitests: {
    // ... existing uitests actions
    "go-to-new-child": uiTestsActions.goToNewChildPage,
  },
  newchildpage: {
    "child-specific-action": newChildPageActions.childSpecificAction,
    "another-action": newChildPageActions.anotherAction,
  },
};
```

#### 6d. Update Dependencies Array

```typescript
// Add newChildPageActions to the dependencies
}, [currentPage, playUIClick, /* ... existing deps */, newChildPageActions, onClose])
```

### 7. Update Parent Page Routing

In the parent page component (e.g., `src/pages/uitests/UITestPage.tsx`):

```typescript
import { NewChildPageWrapper } from "../../components/NewChildPageWrapper";

export const UITestPage: React.FC = () => {
  const currentChildPage = useAppStore((state) => state.currentChildPage);

  let CurrentPageComponent = UITestsMainPage;

  if (currentChildPage === "dragtest") {
    CurrentPageComponent = DragTestPageWrapper;
  } else if (currentChildPage === "uiaudiotest") {
    CurrentPageComponent = UIAudioTestPageWrapper;
  } else if (currentChildPage === "newchildpage") {
    CurrentPageComponent = NewChildPageWrapper;
  }

  return (
    <div className="relative h-full">
      <CurrentPageComponent />
    </div>
  );
};
```

### 8. Add Instructions

In `src/services/instructions/InstructionsService.ts`, add your page instructions to the `initializeInstructions()` method:

```typescript
private initializeInstructions(): void {
  // ... existing instructions

  this.instructionsMap.set('parent.newchildpage', {
    title: 'New Child Page Instructions',
    instructions: [
      'Step 1: Do something specific',
      'Step 2: Perform another action', 
      'Step 3: Complete the workflow',
      'Additional helpful instructions for users'
    ]
  })

  // ... rest of method
}
```

**Note:** Use hierarchical page IDs like `'parent.newchildpage'` to match the pattern used in `usePageInstructions()`.

## Common Actions System

The common actions system eliminates code duplication by centralizing reusable navigation actions. This is especially useful for cross-navigation between sibling pages.

### Understanding Common Actions

**File Location:** `src/constants/actions/common-actions.constants.ts`

#### Key Components:

1. **COMMON_ACTIONS** - Dictionary of reusable action definitions
2. **COMMON_ACTION_GROUPS** - Predefined groups like `splashSiblings`, `uitestSiblings`, `demoUtilities`
3. **Helper functions** - `buildCommonActions()` and `mergeWithCommonActions()`

#### Predefined Action Groups:

```typescript
// Available groups in COMMON_ACTION_GROUPS:
splashSiblings: ['go-to-minimal', 'go-to-animated', 'go-to-progress', 'go-to-branded']
uitestSiblings: ['go-to-drag-test', 'go-to-audio-test', 'go-to-layout-test', 'go-to-mobile-drag-test']
demoUtilities: ['toggle-fullscreen', 'restart-animation']
```

### Adding New Common Actions

1. **Add to COMMON_ACTIONS dictionary:**
```typescript
export const COMMON_ACTIONS: Record<string, ActionSheetAction> = {
  // ... existing actions
  'go-to-your-page': {
    id: 'go-to-your-page',
    label: '‚Üí Your Page',
    icon: Navigation,
    variant: 'secondary'
  }
}
```

2. **Add to appropriate action group:**
```typescript
export const COMMON_ACTION_GROUPS = {
  // ... existing groups
  uitestSiblings: [
    'go-to-drag-test',
    'go-to-audio-test', 
    'go-to-layout-test',
    'go-to-mobile-drag-test',
    'go-to-your-page' // Add here
  ]
}
```

3. **All pages using that group automatically get the new action**

### Usage Examples:

```typescript
// Pages with only common actions (no page-specific actions)
layouttest: [...buildCommonActions(['go-to-drag-test', 'go-to-audio-test', 'go-to-mobile-drag-test'])],

// Pages with both page-specific and common actions  
dragtest: mergeWithCommonActions([
  { id: 'reset-board', label: 'Reset Board', icon: RotateCcw, variant: 'secondary' },
  { id: 'test-move-sound', label: 'Test Move Sound', icon: Volume2, variant: 'default' },
], ['go-to-audio-test', 'go-to-layout-test', 'go-to-mobile-drag-test']),

// Parent pages using predefined groups
uitests: [...COMMON_ACTION_GROUPS.uitestSiblings.map(name => ({
  ...COMMON_ACTIONS[name],
  variant: 'secondary' as const
}))],
```

## Quick Checklist

### Basic Setup
- [ ] Child page component created
- [ ] Wrapper component with `usePageInstructions`
- [ ] Child actions added to `PAGE_ACTIONS` (with or without common actions)
- [ ] Child actions hook created
- [ ] All actions wired up in `ActionSheetContainer`
- [ ] Parent page routing updated

### Navigation Setup
- [ ] Parent navigation action added to parent's hook
- [ ] Parent navigation action added to parent's `PAGE_ACTIONS` (or common actions)
- [ ] If using common actions: Added new navigation to `COMMON_ACTIONS`
- [ ] If using common actions: Added to appropriate `COMMON_ACTION_GROUPS`

### Optional
- [ ] Instructions added to `InstructionsService`
- [ ] Cross-navigation to sibling pages using common actions
- [ ] Audio feedback configured for actions

## Common Mistakes

1. **Inconsistent page IDs** - Use the same ID everywhere (`"newchildpage"`)
2. **Missing wrapper component** - Child pages need wrappers for context
3. **Forgot action mapping** - Actions must be mapped in `ActionSheetContainer`
4. **Missing routing** - Parent page must handle child page routing
5. **Dependencies not updated** - Add new action hooks to dependencies array
6. **Common actions not imported** - Missing `import { mergeWithCommonActions, buildCommonActions, COMMON_ACTIONS, COMMON_ACTION_GROUPS } from './common-actions.constants'`
7. **Action group inconsistency** - Adding navigation action to common actions but forgetting to add to appropriate group
8. **Overcomplicating simple pages** - Use `buildCommonActions()` for pages that only need navigation

## Testing Your Implementation

1. Navigate to parent tab
2. Open action sheet - should see navigation action
3. Click navigation action - should navigate to child page
4. Open action sheet from child page - should see child-specific actions
5. Click tab again - should return to parent page main view
6. Reload page - should remember child page state (if persisted)

## File Locations Summary

| Component         | File Path                                                      |
| ----------------- | -------------------------------------------------------------- |
| Child Page        | `src/pages/{parent}/NewChildPage.tsx`                          |
| Wrapper           | `src/components/NewChildPageWrapper.tsx`                       |
| Actions Hook      | `src/hooks/useNewChildPageActions.ts`                          |
| Actions Config    | `src/constants/actions/page-actions.constants.ts`              |
| Common Actions    | `src/constants/actions/common-actions.constants.ts`            |
| Action Mapping    | `src/components/action-sheet/ActionSheetContainer.tsx`         |
| Parent Routing    | `src/pages/{parent}/{Parent}Page.tsx`                          |
| Instructions      | `src/services/instructions/InstructionsService.ts` (add to `initializeInstructions()`) |

This system ensures child pages have their own instructions and actions while maintaining clean navigation and proper context switching.

## Lessons Learned - Common Pitfalls

### 1. Missing Action Handlers with Common Actions

**Problem:** When using `mergeWithCommonActions()` or `buildCommonActions()`, the PAGE_ACTIONS configuration gets the navigation actions, but ActionSheetContainer might not have the handlers mapped for child pages.

**Symptom:** Console warning: `‚ö†Ô∏è [ACTION SHEET] No handler found for action: go-to-layout-test on page: dragtest`

**Solution:** Ensure all navigation actions are mapped in BOTH places:

1. **PAGE_ACTIONS** (via common actions) ‚úÖ
2. **ActionSheetContainer actionMap** (manual mapping required) ‚ùå Often forgotten

**Example Fix:**
```typescript
// In ActionSheetContainer.tsx actionMap:
dragtest: {
  // Page-specific actions
  'reset-board': dragTestActions.resetBoard,
  'test-move-sound': dragTestActions.testMoveSound,
  
  // Navigation actions (must be added manually!)
  'go-to-audio-test': uiTestsActions.goToAudioTest,
  'go-to-layout-test': uiTestsActions.goToLayoutTest,
  'go-to-mobile-drag-test': uiTestsActions.goToMobileDragTest
},
```

**Prevention:** When adding common actions to child pages, always check that the parent's navigation handlers are mapped in each child page's actionMap section.

### 2. Empty Action Maps

**Problem:** Pages defined in PAGE_ACTIONS but have empty actionMap entries (`layouttest: {}`)

**Impact:** All actions for that page fail silently

**Solution:** Always populate actionMap entries, even if only with navigation actions:
```typescript
layouttest: {
  // Navigation actions only
  'go-to-drag-test': uiTestsActions.goToDragTest,
  'go-to-audio-test': uiTestsActions.goToAudioTest,
  'go-to-mobile-drag-test': uiTestsActions.goToMobileDragTest
},
```

### 3. Common Actions System Gotchas

**The Gap:** Common actions system handles action DEFINITIONS but not action HANDLERS

- ‚úÖ `COMMON_ACTIONS` defines what actions look like
- ‚úÖ `mergeWithCommonActions()` adds them to PAGE_ACTIONS
- ‚ùå ActionSheetContainer mapping is still manual

**Best Practice:** After using common actions, always audit ActionSheetContainer for missing handlers.

### 4. Debugging Action Issues

**Console Warnings to Watch For:**
```
‚ö†Ô∏è [ACTION SHEET] No handler found for action: [action-name] on page: [page-name]
```

**Debugging Steps:**
1. Check if action exists in PAGE_ACTIONS for that page ‚úì
2. Check if action exists in ActionSheetContainer actionMap ‚úó (usually the issue)
3. Check if parent's action hooks have the required function
4. Check if action hook is imported and used in ActionSheetContainer

**Quick Fix:** Add the missing handler to the actionMap section for that page.
